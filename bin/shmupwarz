#!/usr/bin/env gjs
Object.defineProperties(window,{define:{value:function(modules){return function(name,deps,callback){if("string"!=typeof name){var bundle=deps();for(name in bundle)modules[name]={id:name,exports:bundle[name]}}else{modules[name]={id:name,exports:{}};for(var args=[function(name){return modules[name]?modules[name].exports:imports[name]},modules[name].exports],i=2;i<deps.length;i++)args.push(modules[deps[i]].exports);callback.apply(modules[name].exports,args)}}}({Lang:{id:"Lang",exports:imports.lang},Sdx:{id:"Sdx",exports:imports.gi.sdx}})},console:{value:{log:function(){print.apply(null,arguments)},warn:function(){print.apply(null,arguments)},error:function(){print.apply(null,arguments)},info:function(){print.apply(null,arguments)}}},_:{value:imports.gettext.gettext}}),Object.defineProperties(define,{amd:{value:!0},version:{value:"0.1.0"},path:{value:function(path){return imports.searchPath.unshift(path)}},imports:{value:function(libs){return define([],function(){return libs})}}}),Object.defineProperties(String.prototype,{printf:{value:imports.format.format}}),define("game",["require","exports","Sdx"],function(require,exports,sdx){"use strict";Object.defineProperties(sdx,{createGame:{value:function(t,h,w,b){var g=sdx.createJsGame(t,h,w,b);return Object.defineProperties(g,{mouseX:{get:function(){return g.get_mouse_x()}},mouseY:{get:function(){return g.get_mouse_y()}},mouseDown:{get:function(){return g.get_mouse_down()}},showFps:{get:function(){return g.get_show_fps()}},deltaTime:{get:function(){return g.get_delta_time()}}}),Object.defineProperties(sdx.Sdx.graphics,{deltaTime:{get:function(){return sdx.Sdx.graphics.get_deltaTime()}},pixelFactor:{get:function(){return sdx.Sdx.graphics.get_pixelFactor()}}}),Object.defineProperties(sdx.Sdx.files,{isResource:{get:function(){return sdx.Sdx.files.get_isResource()}},resourcePath:{get:function(){return sdx.Sdx.files.get_resourcePath()}}}),g}}}),Object.defineProperties(sdx.Sdx,{app:{get:function(){return sdx.Sdx.get_app()}},graphics:{get:function(){return sdx.Sdx.get_graphics()}},audio:{get:function(){return sdx.Sdx.get_audio()}},input:{get:function(){return sdx.Sdx.get_input()}},files:{get:function(){return sdx.Sdx.get_files()}}}),Object.defineProperties(sdx,{graphics:{value:{}}}),Object.defineProperties(sdx.graphics,{Color:{value:{}}}),Object.defineProperties(sdx.graphics.Color,{CLEAR:{get:function(){return sdx.graphicsColor.get_CLEAR()}},BLACK:{get:function(){return sdx.graphicsColor.get_BLACK()}},WHITE:{get:function(){return sdx.graphicsColor.get_WHITE()}},LIGHT_GRAY:{get:function(){return sdx.graphicsColor.get_LIGHT_GRAY()}},GRAY:{get:function(){return sdx.graphicsColor.get_GRAY()}},DARK_GRAY:{get:function(){return sdx.graphicsColor.get_DARK_GRAY()}},BLUE:{get:function(){return sdx.graphicsColor.get_BLUE()}},NAVY:{get:function(){return sdx.graphicsColor.get_NAVY()}},ROYAL:{get:function(){return sdx.graphicsColor.get_ROYAL()}},SLATE:{get:function(){return sdx.graphicsColor.get_SLATE()}},SKY:{get:function(){return sdx.graphicsColor.get_SKY()}},CYAN:{get:function(){return sdx.graphicsColor.get_CYAN()}},TEAL:{get:function(){return sdx.graphicsColor.get_TEAL()}},GREEN:{get:function(){return sdx.graphicsColor.get_GREEN()}},CHARTREUSE:{get:function(){return sdx.graphicsColor.get_CHARTREUSE()}},LIME:{get:function(){return sdx.graphicsColor.get_LIME()}},FOREST:{get:function(){return sdx.graphicsColor.get_FOREST()}},OLIVE:{get:function(){return sdx.graphicsColor.get_OLIVE()}},YELLOW:{get:function(){return sdx.graphicsColor.get_YELLOW()}},GOLD:{get:function(){return sdx.graphicsColor.get_GOLD()}},GOLDENROD:{get:function(){return sdx.graphicsColor.get_GOLDENROD()}},ORANGE:{get:function(){return sdx.graphicsColor.get_ORANGE()}},BROWN:{get:function(){return sdx.graphicsColor.get_BROWN()}},TAN:{get:function(){return sdx.graphicsColor.get_TAN()}},FIREBRICK:{get:function(){return sdx.graphicsColor.get_FIREBRICK()}},RED:{get:function(){return sdx.graphicsColor.get_RED()}},SCARLET:{get:function(){return sdx.graphicsColor.get_SCARLET()}},SALMON:{get:function(){return sdx.graphicsColor.get_SALMON()}},PINK:{get:function(){return sdx.graphicsColor.get_PINK()}},MAGENTA:{get:function(){return sdx.graphicsColor.get_MAGENTA()}},PURPLE:{get:function(){return sdx.graphicsColor.get_PURPLE()}},VIOLET:{get:function(){return sdx.graphicsColor.get_VIOLET()}},MAROON:{get:function(){return sdx.graphicsColor.get_MAROON()}}}),Object.defineProperties(sdx.Input,{Keys:{value:{Esc:27,a:97,b:98,c:99,d:100,e:101,f:102,g:103,h:104,i:105,j:106,k:107,l:108,m:109,n:110,o:111,p:112,q:113,r:114,s:115,t:116,u:117,v:118,w:119,x:120,y:121,z:122}}})});var DATADIR="/home/bruce/gjs/sdxjs/data";define("entities",["require","exports","Sdx","Sdx"],function(require,exports,sdx,Sdx_1){"use strict";function createPool(game){var z=0;exports.active.push(exports.pool[z++]=createPlayer()),exports.active.push(exports.pool[z++]=createBackground());for(var i=0;BULLETS>i;i++)bulletQ.push(exports.pool[z++]=createBullet());for(var i=0;ENEMY1>i;i++)enemy1Q.push(exports.pool[z++]=createEnemy1());for(var i=0;ENEMY2>i;i++)enemy2Q.push(exports.pool[z++]=createEnemy2());for(var i=0;ENEMY3>i;i++)enemy3Q.push(exports.pool[z++]=createEnemy3());for(var i=0;EXPLOSIONS>i;i++)explosionQ.push(exports.pool[z++]=createExplosion());for(var i=0;BANGS>i;i++)bangQ.push(exports.pool[z++]=createBang());for(var i=0;PARTICLES>i;i++)particleQ.push(exports.pool[z++]=createParticle());game.addSprite(exports.active[0].sprite),game.addSprite(exports.active[1].sprite),Object.freeze(exports.pool)}function deactivate(game,e){e.active=!1;var z=exports.active.remove(e);if(z.id!==e.id)throw new Error("removed wrong entity");if(game.removeSprite(e.sprite),e.bang)bangQ.push(e);else if(e.particle)particleQ.push(e);else if(e.explosion)explosionQ.push(e);else if(e.bullet)bulletQ.push(e);else if(e.enemy)switch(e.model){case 1:enemy1Q.push(e);break;case 2:enemy2Q.push(e);break;case 3:enemy3Q.push(e)}}function bang(game,x,y){if(!bangQ.length)throw new Error("Unable to allocate bang");var e=bangQ.pop();e.active=!0,e.position.x=x,e.position.y=y,e.scale.x=.2,e.scale.y=.2,e.tween.active=!0,e.expires=.2,game.addSprite(e.sprite),exports.active.push(e)}function particle(game,x,y){if(!particleQ.length)throw new Error("Unable to allocate particle");var e=particleQ.pop();e.active=!0,e.position.x=x,e.position.y=y,e.expires=.2,game.addSprite(e.sprite),exports.active.push(e)}function explosion(game,x,y){if(!explosionQ.length)throw new Error("Unable to allocate explosion");var e=explosionQ.pop();e.active=!0,e.position.x=x,e.position.y=y,e.tween.active=!0,e.scale.x=.5,e.scale.y=.5,e.expires=.2,game.addSprite(e.sprite),exports.active.push(e)}function bullet(game,x,y){if(!bulletQ.length)throw new Error("Unable to allocate bullet");var e=bulletQ.pop();e.active=!0,e.position.x=x,e.position.y=y,game.addSprite(e.sprite),exports.active.push(e)}function enemy1(game){if(!enemy1Q.length)throw new Error("Unable to allocate enemy1");var e=enemy1Q.pop();e.position.x=Math.random()*(game.width-e.bounds.w)+e.bounds.w/2,e.position.y=e.bounds.h,e.health.current=e.health.maximum,e.active=!0,game.addSprite(e.sprite),exports.active.push(e)}function enemy2(game){if(!enemy2Q.length)throw new Error("Unable to allocate enemy2");var e=enemy2Q.pop();e.position.x=Math.random()*(game.width-e.bounds.w)+e.bounds.w/2,e.position.y=e.bounds.h,e.health.current=e.health.maximum,e.active=!0,game.addSprite(e.sprite),exports.active.push(e)}function enemy3(game){if(!enemy3Q.length)throw new Error("Unable to allocate enemy3");var e=enemy3Q.pop();e.position.x=Math.random()*(game.width-e.bounds.w)+e.bounds.w/2,e.position.y=e.bounds.h,e.health.current=e.health.maximum,e.active=!0,game.addSprite(e.sprite),exports.active.push(e)}function createBackground(){var sprite=sdx.createSprite("images/BackdropBlackLittleSparkBlack.png");return sprite.centered=!1,{id:uniqueId++,active:!0,scale:{x:3,y:3},position:{x:0,y:0},velocity:{x:0,y:0},sprite:sprite}}function createPlayer(){var sprite=sdx.createSprite("images/spaceshipspr.png");return sprite.layer=8,{id:uniqueId++,player:!0,active:!0,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},velocity:{x:0,y:0},sprite:sprite}}function createBullet(){var sprite=sdx.createSprite("images/bullet.png");return sprite.layer=9,{id:uniqueId++,bullet:!0,active:!1,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},velocity:{x:0,y:-800},tint:{r:210,g:250,b:0,a:255},sound:sdx.createSound("sounds/pew.wav"),sprite:sprite}}function createEnemy1(){var text=sdx.createText("100%",Sdx_1.Sdx.app.font,sdx.graphics.Color.CHARTREUSE),sprite=sdx.createSprite("images/enemy1.png");return sprite.layer=5,{id:uniqueId++,enemy:!0,active:!1,model:1,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},velocity:{x:0,y:40},health:{current:10,maximum:10},text:text,sprite:sprite}}function createEnemy2(){var text=sdx.createText("100%",Sdx_1.Sdx.app.font,sdx.graphics.Color.CHARTREUSE),sprite=sdx.createSprite("images/enemy2.png");return sprite.layer=6,{id:uniqueId++,enemy:!0,active:!1,model:2,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},velocity:{x:0,y:30},health:{current:20,maximum:20},text:text,sprite:sprite}}function createEnemy3(){var text=sdx.createText("100%",Sdx_1.Sdx.app.font,sdx.graphics.Color.CHARTREUSE),sprite=sdx.createSprite("images/enemy3.png");return sprite.layer=7,{id:uniqueId++,enemy:!0,active:!1,model:3,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},velocity:{x:0,y:20},health:{current:60,maximum:60},text:text,sprite:sprite}}function createExplosion(){var sprite=sdx.createSprite("images/explosion.png");return sprite.layer=10,{id:uniqueId++,explosion:!0,active:!1,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},scale:{x:.5,y:.5},tween:{min:.005,max:.5,speed:-3,repeat:!1,active:!0},tint:{r:210,g:250,b:210,a:250},sound:sdx.createSound("asplode/pew.wav"),expires:.2,sprite:sprite}}function createBang(){var sprite=sdx.createSprite("images/explosion.png");return sprite.layer=10,{id:uniqueId++,bang:!0,active:!1,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},scale:{x:.2,y:.2},tween:{min:.002,max:.2,speed:-3,repeat:!1,active:!0},tint:{r:210,g:250,b:210,a:250},sound:sdx.createSound("smallasplode/pew.wav"),expires:.2,sprite:sprite}}function createParticle(){var radians=Math.random()*Tau,magnitude=Math.ceil(200*Math.random()),velocityX=magnitude*Math.cos(radians),velocityY=magnitude*Math.sin(radians),scale=Math.random(),sprite=sdx.createSprite("images/star.png");return sprite.layer=10,{id:uniqueId++,particle:!0,active:!1,bounds:{x:0,y:0,w:sprite.width,h:sprite.height},position:{x:0,y:0},scale:{x:scale,y:scale},velocity:{x:velocityX,y:velocityY},tint:{r:250,g:250,b:210,a:255},expires:.4,sprite:sprite}}var Tau=6.28318,BULLETS=20,ENEMY1=9,ENEMY2=7,ENEMY3=5,ENEMIES=ENEMY1+ENEMY2+ENEMY3,EXPLOSIONS=8,BANGS=16,PARTICLES=40,bulletQ=[],particleQ=[],explosionQ=[],bangQ=[],enemy1Q=[],enemy2Q=[],enemy3Q=[];exports.pool=new Array(2+BULLETS+ENEMIES+EXPLOSIONS+BANGS+PARTICLES),exports.active=[];var uniqueId=0;Array.prototype.remove=function(e){var i=this.indexOf(e);if(i>-1){if(this[i].id!==e.id)throw new Error("Invalid remove id");return this.splice(i,1)[0]}throw print(JSON.stringify(e,null,2)),new Error("Unable to remove "+e.id)},exports.createPool=createPool,exports.deactivate=deactivate,exports.bang=bang,exports.particle=particle,exports.explosion=explosion,exports.bullet=bullet,exports.enemy1=enemy1,exports.enemy2=enemy2,exports.enemy3=enemy3}),define("systems",["require","exports","Sdx","Sdx"],function(require,exports,sdx,Sdx_2){"use strict";function healthSystem(game,entities){for(var _i=0,_a=entities.active;_i<_a.length;_i++){var e=_a[_i];if(e.active&&e.health&&e.text){var pct=e.health.current/e.health.maximum*100,str="%3f%%".printf(pct);str!==e.text.text&&(e.text=sdx.createText(str,Sdx_2.Sdx.app.font,sdx.graphics.Color.CHARTREUSE)),e.text.x=e.position.x,e.text.y=e.position.y,game.addOnce(e.text)}}}function inputSystem(game,entities){var player=entities.pool[0];player.position.x=game.mouseX,player.position.y=game.mouseY,(game.mouseDown||game.getKey(sdx.Input.Keys.z))&&(timeToFire-=game.deltaTime,0>timeToFire&&(timeToFire=fireRate,entities.bullet(game,game.mouseX+27,game.mouseY+2),entities.bullet(game,game.mouseX-27,game.mouseY+2)))}function soundSystem(game,entities){for(var _i=0,_a=entities.active;_i<_a.length;_i++){var e=_a[_i];e.active&&e.sound&&e.sound.play(0)}}function physicsSystem(game,entities){for(var _i=0,_a=entities.active;_i<_a.length;_i++){var e=_a[_i];e.active&&(e.velocity&&(e.position.x+=e.velocity.x*game.deltaTime,e.position.y+=e.velocity.y*game.deltaTime),e.bounds&&(e.bounds.x=e.position.x-e.bounds.w/4,e.bounds.y=e.position.y-e.bounds.h/2),e.sprite.x=e.position.x,e.sprite.y=e.position.y,e.scale&&e.sprite.setScale(e.scale.x,e.scale.y),e.tint&&e.sprite.setColor(e.tint.r,e.tint.g,e.tint.b))}}function expireSystem(game,entities){for(var _i=0,_a=entities.active;_i<_a.length;_i++){var e=_a[_i];e.player||e.active&&e.expires&&(e.expires-=game.deltaTime,e.expires<0&&entities.deactivate(game,e))}}function removalSystem(game,entities){for(var _i=0,_a=entities.active;_i<_a.length;_i++){var e=_a[_i];e.player||(e.active&&e.position.y<0||e.position.y>game.height)&&entities.deactivate(game,e)}}function tweenSystem(game,entities){for(var _i=0,_a=entities.active;_i<_a.length;_i++){var e=_a[_i];if(e.active&&e.tween){var tween=e.tween,x=e.scale.x+tween.speed*game.deltaTime,y=e.scale.y+tween.speed*game.deltaTime,active=e.tween.active;x>tween.max?(x=tween.max,y=tween.max,active=!1):x<tween.min&&(x=tween.min,y=tween.min,active=!1),e.scale.x=x,e.scale.y=y,e.tween.active=active}}}function spawnSystem(game,entities){function spawn(t,enemy){var d1=t-game.deltaTime;if(!(0>d1))return d1;switch(enemy){case 1:return entities.enemy1(game),T1;case 2:return entities.enemy2(game),T2;case 3:return entities.enemy3(game),T3;default:throw new Error("WTF")}}enemyT1=spawn(enemyT1,1),enemyT2=spawn(enemyT2,2),enemyT3=spawn(enemyT3,3)}function collisionSystem(game,entities){for(var _i=0,_a=entities.active;_i<_a.length;_i++){var e=_a[_i];if(e.active&&e.enemy)for(var _b=0,_c=entities.active;_b<_c.length;_b++){var b=_c[_b];b.active&&b.bullet&&intersects(e,b)&&handleCollision(game,e,b,entities)}}}function intersects(a,b){var r1=a.bounds,r2=b.bounds;return r1.x<r2.x+r2.w&&r1.x+r1.w>r2.x&&r1.y<r2.y+r2.h&&r1.y+r1.h>r2.y}function handleCollision(game,enemy,bullet,entities){var x=bullet.position.x,y=bullet.position.y;entities.bang(game,x,y),entities.deactivate(game,bullet);for(var i=0;4>i;i++)entities.particle(game,x,y);enemy.health&&(enemy.health.current-=2,enemy.health.current<0&&(x=enemy.position.x,y=enemy.position.y,entities.deactivate(game,enemy),entities.explosion(game,x,y)))}var fireRate=.1,timeToFire=0,T1=2,T2=5,T3=7,enemyT1=T1,enemyT2=T2,enemyT3=T3;exports.healthSystem=healthSystem,exports.inputSystem=inputSystem,exports.soundSystem=soundSystem,exports.physicsSystem=physicsSystem,exports.expireSystem=expireSystem,exports.removalSystem=removalSystem,exports.tweenSystem=tweenSystem,exports.spawnSystem=spawnSystem,exports.collisionSystem=collisionSystem}),define("game",["require","exports","Sdx","entities","systems"],function(require,exports,sdx,entities,systems){"use strict";function main(){var game=sdx.createGame("ShmupWarz",640,640,DATADIR);for(entities.createPool(game),game.profile=!0,game.start();game.running&&(game.handleEvents(),!game.getKey(sdx.Input.Keys.Esc));)systems.collisionSystem(game,entities),systems.expireSystem(game,entities),systems.removalSystem(game,entities),systems.spawnSystem(game,entities),systems.tweenSystem(game,entities),systems.inputSystem(game,entities),systems.physicsSystem(game,entities),systems.healthSystem(game,entities),systems.soundSystem(game,entities),game.draw()}main()});